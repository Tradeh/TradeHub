<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: #0a0a0f; color: #fff; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .card { width: 100%; max-width: 460px; background: rgba(15, 15, 25, 0.92); border: 1px solid rgba(99, 102, 241, 0.25); border-radius: 20px; padding: 1.5rem; box-shadow: 0 25px 50px rgba(0,0,0,0.5); }
        .title { text-align: center; font-size: 1.6rem; font-weight: 700; margin-bottom: 0.25rem; background: linear-gradient(135deg, #6366f1, #a855f7, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .subtitle { text-align: center; color: #94a3b8; margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1rem; }
        .label { display: block; color: #e2e8f0; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.95rem; }
        .input { width: 100%; background: rgba(20,20,30,0.85); border: 1px solid rgba(99,102,241,0.25); border-radius: 12px; padding: 0.9rem 1rem; color: #fff; font-size: 1rem; }
        .input:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,0.12); }
        .hint { color: #64748b; font-size: 0.85rem; margin-top: 0.35rem; }
        .btn { width: 100%; margin-top: 0.75rem; padding: 0.9rem 1rem; border-radius: 12px; border: 0; color: #fff; font-weight: 700; cursor: pointer; background: linear-gradient(135deg, #6366f1, #a855f7); }
        .row { display: flex; gap: 0.75rem; }
        .row .input { flex: 1; }
        .success { display: none; text-align: center; margin-top: 1rem; color: #10b981; font-weight: 600; }
        .back { position: absolute; top: 1.5rem; right: 1.5rem; color: #6366f1; text-decoration: none; }
        @media (max-width: 420px) {
            .title { font-size: 1.35rem; }
            .subtitle { font-size: 0.9rem; }
            .card { padding: 1.25rem; }
        }
    </style>
</head>
<body>
    <a class="back" href="index.html" title="Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"><i class="fas fa-home"></i></a>
    <div class="card">
        <div class="title">Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
        <div class="subtitle">Ø§Ø®ØªØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙ‚Ø·</div>
        <form id="setup-form">
            <div class="form-group">
                <label class="label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                <input id="username" class="input" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" required maxlength="10" pattern="^[A-Za-z\u0600-\u06FF]{1,10}$" title="Ø§Ù„Ø§Ø³Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø­Ø±ÙˆÙ ÙÙ‚Ø· (Ø¹Ø±Ø¨ÙŠ/Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ) ÙˆØ¨Ø­Ø¯ Ø£Ù‚ØµÙ‰ 10">
                <div class="hint">ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ±Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.</div>
            </div>
            <div class="form-group">
                <label class="label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <input id="password" class="input" type="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required minlength="8" pattern="(?=.*[a-z])(?=.*[A-Z])(?=.*[^A-Za-z0-9]).{8,}" title="ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙˆØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø­Ø±Ù ÙƒØ¨ÙŠØ± ÙˆØ­Ø±Ù ØµØºÙŠØ± ÙˆØ±Ù…Ø²">
                <div class="hint">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ 8 Ø£Ø­Ø±ÙØŒ Ù…Ø¹ Ø­Ø±Ù ÙƒØ¨ÙŠØ± ÙˆØµØºÙŠØ± ÙˆØ±Ù…Ø².</div>
            </div>
            <button class="btn" type="submit">Ø­ÙØ¸ ÙˆÙ…ØªØ§Ø¨Ø¹Ø©</button>
            <div id="ok" class="success">ØªÙ… Ø§Ù„Ø­ÙØ¸! Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ø®Ù„Ø§Ù„ Ù„Ø­Ø¸Ø§Øª...</div>
        </form>
    </div>

    <script>

        const USERS_KEY = 'app_users_json';
        const CURRENT_USER_KEY = 'app_current_user';


        async function apiSaveUser(email, pass, name='') {
            try {
                const res = await fetch('/api/storage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, pass, name })
                });
                if (res.status === 409) return false;
                return res.ok;
            } catch (_) { return false; }
        }
        async function apiAccountExists(email) {
            try {
                const res = await fetch('/api/account_exists?email=' + encodeURIComponent(email), { cache: 'no-store' });
                if (!res.ok) return false;
                const data = await res.json();
                return !!(data && data.exists);
            } catch (_) { return false; }
        }

        function isStrongPassword(pass) {
            return /^(?=.*[a-z])(?=.*[A-Z])(?=.*[^A-Za-z0-9]).{8,}$/.test(pass || '');
        }
        function getPasswordError(pass) {
            if (!pass || pass.length < 8) return 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.';
            if (!/[A-Z]/.test(pass)) return 'ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ù„Ù‰ Ø­Ø±Ù Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ ÙƒØ¨ÙŠØ± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.';
            if (!/[a-z]/.test(pass)) return 'ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ù„Ù‰ Ø­Ø±Ù Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ ØµØºÙŠØ± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.';
            if (!/[^A-Za-z0-9]/.test(pass)) return 'ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù…Ø² ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.';
            return '';
        }

        function loadUsers() {
            try {
                const raw = localStorage.getItem(USERS_KEY);
                return raw ? JSON.parse(raw) : {};
            } catch (_) { return {}; }
        }
        function saveUsers(users) {
            try { localStorage.setItem(USERS_KEY, JSON.stringify(users)); } catch (_) {}
        }
        function setCurrentUser(email) {
            try { localStorage.setItem(CURRENT_USER_KEY, email); } catch (_) {}
        }


        const params = new URLSearchParams(location.search);
        const prefillName = params.get('name') || params.get('email') || '';
        if (prefillName) document.getElementById('username').value = prefillName;
        function handleTamperAttempt() {
            try {

                const lock = { until: Date.now() + 2 * 60 * 1000 };
                localStorage.setItem('setup_lockout', JSON.stringify(lock));
            } catch (_) {}
            try { sessionStorage.clear(); } catch (_) {}
            try { localStorage.removeItem('google_email_verified'); } catch (_) {}
            alert('Ù…Ø­Ø§ÙˆÙ„Ø© ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ù‡Ø§ ØªÙ… Ø§ÙƒØªØ´Ø§ÙÙ‡Ø§. ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙˆØ¥Ø¹Ø§Ø¯ØªÙƒ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„.');
            window.location.replace('auth.html');
        }

        const googleEmail = (function(){
            const fromQuery = params.get('email') || '';
            let verified = '';
            try { verified = sessionStorage.getItem('google_email_verified') || ''; } catch (_) {}

            if (fromQuery && verified && fromQuery.toLowerCase() === verified.toLowerCase()) {
                return fromQuery;
            }
            if (fromQuery) {

                handleTamperAttempt();
            }
            return '';
        })();


        try {
            const rawLock = localStorage.getItem('setup_lockout');
            if (rawLock) {
                const lock = JSON.parse(rawLock);
                if (lock && typeof lock.until === 'number' && Date.now() < lock.until) {
                    const remaining = Math.ceil((lock.until - Date.now()) / 1000);
                    alert('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¤Ù‚ØªØ§Ù‹. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ ' + remaining + ' Ø«Ø§Ù†ÙŠØ©.');
                    window.location.replace('auth.html');
                } else {
                    localStorage.removeItem('setup_lockout');
                }
            }
        } catch (_) {}

        document.getElementById('setup-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            if (!username || !password) return;

            const pwdErr = getPasswordError(password);
            if (pwdErr) { alert(pwdErr); return; }


            let serverSaved = false;
            if (googleEmail) {
                serverSaved = await apiSaveUser(googleEmail, password, username);
                if (!serverSaved) {
                    alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ù†Ø´Ø§Ø¡/ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ù‚Ù‚.');
                    return; // Ø£ÙˆÙ‚Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø®Ø§Ø¯Ù…ÙŠ (Ù…Ø«Ù„ 409)
                }
            }


            const users = loadUsers();
            const key = googleEmail || ('user:' + username);
            if (!users[key]) users[key] = {};
            users[key].username = username;
            users[key].password = password;
            users[key].email = googleEmail || null;
            users[key].createdAt = users[key].createdAt || new Date().toISOString();
            users[key].updatedAt = new Date().toISOString();
            saveUsers(users);


            setCurrentUser(key);
            document.getElementById('ok').style.display = 'block';
            setTimeout(() => { window.location.href = 'index.html'; }, 900);
        });


        (function(){
            try {
                const u = document.getElementById('username');
                if (!u) return;
                const sanitize = (val) => (val || '').replace(/[^A-Za-z\u0600-\u06FF]/g, '').slice(0,10);
                u.addEventListener('input', function(){
                    const clean = sanitize(this.value);
                    if (this.value !== clean) this.value = clean;
                });
                u.addEventListener('paste', function(e){
                    e.preventDefault();
                    const text = (e.clipboardData || window.clipboardData).getData('text');
                    const clean = sanitize(text);
                    document.execCommand('insertText', false, clean);
                });
            } catch(_) {}
        })();


        document.addEventListener('keydown', function(e) { if (e.key === 'Escape') window.location.href = 'index.html'; });
    </script>
</body>
</html>




